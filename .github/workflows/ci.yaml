name: Homelab #16 CI – Build, Scan, Lint & Update Manifest

on:
  push:
    branches: [main]
    paths:
    - 'Homelab16 - GitOps and Secrets Management/**'
  pull_request:
    branches: [main]
    paths:
    - 'Homelab16 - GitOps and Secrets Management/**'

jobs:
  lint-built-scan:
    runs-on: ubuntu-latest
    permissions:
      security-events: write  # Required for CodeQL
      contents: write         # Required for git push
      actions: read           # Required for CodeQL
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      
      # ====================================================================
      # Lint Kubernetes Manifests (strict mode)
      # ====================================================================
      - name: Install YamlLint
        run: sudo apt-get update && sudo apt-get install -y yamllint

      - name: Lint YAML files in Homelab 16 Folder
        run: |
          find "Homelab16 - GitOps and Secrets Management" -type f \( -name "*.yaml" -o -name "*.yml" \) \
            -exec yamllint -s {} + || { echo "YAML lint failed (errors or warnings)"; exit 1; }

      # ====================================================================
      # SAST - CodeQL Security Scanning for Python (BEFORE building image)
      # ====================================================================
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

      # ====================================================================
      # Check CodeQL Results and Fail if Critical Issues Found
      # ====================================================================
      - name: Check for CodeQL Critical Alerts
        run: |
          SARIF_FILE="${{ github.workspace }}/results/python.sarif"
          
          if [ -f "$SARIF_FILE" ]; then
            CRITICAL_COUNT=$(jq '[.runs[].results[] | select(.level=="error")] | length' "$SARIF_FILE" || echo "0")
            
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "❌ Found $CRITICAL_COUNT critical CodeQL issues"
              echo "Check the Security tab for details"
              exit 1
            else
              echo "✅ No critical CodeQL issues found"
            fi
          else
            echo "⚠️  CodeQL results not found, continuing..."
          fi

      # ====================================================================
      # Docker Build & Push (BEFORE Trivy scan)
      # Set up Docker Buildx: enables advanced multi-platform builds, 
      # caching, and better performance/larger images compared to 
      # default docker build (required for reliable CI image pushes)
      # ====================================================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: "Homelab16 - GitOps and Secrets Management/app"
          file: "Homelab16 - GitOps and Secrets Management/app/Dockerfile"
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/hello-world-app:${{ github.sha }}

      # ====================================================================
      # Trivy Scan to Flag Vulnerabilities (AFTER image is built)
      # The Pipeline Will Fail On Vulnerabilities With High and Critical Severity
      # ====================================================================
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ secrets.DOCKER_USERNAME }}/hello-world-app:${{ github.sha }}'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'HIGH,CRITICAL'

      # ====================================================================
      # Update The Application's Kubernetes Manifest (Only on Main Pushes)
      # Only happens if ALL previous steps passed
      # ====================================================================
      - name: Update image tag in manifest
        if: github.ref == 'refs/heads/main'
        working-directory: "Homelab16 - GitOps and Secrets Management/app/kubernetes_manifests"
        run: |
          sed -i "s|image: .*hello-world-app:.*|image: ${{ secrets.DOCKER_USERNAME }}/hello-world-app:${{ github.sha }}|" \
            helloworld-deployment.yaml

      # ====================================================================
      # Commit and Push
      # ====================================================================
      - name: Commit and push updated manifest
        if: github.ref == 'refs/heads/main'
        working-directory: "Homelab16 - GitOps and Secrets Management/app"
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add kubernetes_manifests/helloworld-deployment.yaml
          git commit -m "ci(homelab-16): bump image tag to ${{ github.sha }} after build & scan" || echo "No changes"
          git push origin HEAD:main